{% extends "layout.html" %}

{% block title %}Home{% endblock %}

{% block content %}
  <div id="left">
    <div id="upper">
      <div id="main-nav">
          <h1>ant<strong>planner</strong></h1>
          <a href="http://github.com/gumho/antplanner2/wiki/AntPlanner-FAQ" title="Help &amp; FAQ"><i class="icon-question-sign icon-large"></i></a>
        </ul>
      </div>
      <div id="cal-ctrl">
        <a href="#" onclick="javascript:print()" title="Print schedule"><i class="icon-print icon-large"></i></a>
        <a href="#" id="save-btn" title="Save schedule"><i class="icon-save icon-large"></i></a>
        <a href="#" id="clear-cal-btn" title="Clear calendar"><i class="icon-remove icon-large"></i></a>
        <a href="#" id="resize-btn" title="Toggle fullscreen"><i class="icon-resize-full icon-large"></i></a>
      </div>
    </div>
    <div id="cal"></div>
  </div>
  <iframe src="{{url_for('websoc_search_form')}}" id="soc" frameborder="0"></iframe>
{% endblock %}

{% block inline_scripts %}
  $(document).ready(function() {
    $('#cal').weekCalendar({
      businessHours: {start: 6, end: 24, limitDisplay: true},
      showHeader: false,
      showColumnHeaderDate: false,
      timeslotsPerHour: 3,
      daysToShow:5,
      readonly: true,
      useShortDayNames: true,
      allowCalEventOverlap: true,
      overlapEventsSeparate: true,
      buttons: false,
      height: function($calendar){ 
        return $(window).height() - $('#upper').outerHeight(); 
      },
      draggable : function(calEvent, element) { return false; },
      resizable : function(calEvent, element) { return false; },
      eventClick : function(calEvent, element) {
        var delCode = calEvent.groupId; 
        $('.wc-cal-event').each(function(index, el) {
          var c = $(el).data().calEvent
          if( c.groupId == delCode ) {
            $('#cal').weekCalendar('removeEvent', c.id);
          }
        });

        localStorage.saved = JSON.stringify( $('#cal').weekCalendar('serializeEvents') );
      },
      data: function(start, end, callback) {
        if(localStorage.saved) {
          callback( JSON.parse(localStorage.saved) );
          groupColorize();
        }
      }
    });

    $('#cal').weekCalendar('gotoWeek', new Date(APP_YEAR, APP_MONTH, APP_DAY));

    $('#soc').load(function(){
      var $listingContext = $('.course-list', $('#soc').contents());
      var $courseRow = $("tr[valign*='top']:not([bgcolor='#fff0ff'])", $listingContext);

        $courseRow.hover(
          function() {
            $(this).css({'color': '#ff0000', 'cursor': 'pointer'});
          },
          function() {
            $(this).css({'color': '#000000', 'cursor': 'default'});
          }
        );

        $courseRow.click(function() {
          var timeString = $(this).find('td').eq(LISTING_TIME_INDEX).html();
          
          // Ignore if course is "TBA"
          if(timeString.indexOf('TBA') != -1) {
            alert('Course is TBA');
            return;
          }

          var courseCode = $(this).find('td').eq(LISTING_CODE_INDEX).text();

          // Ignore if course already added
          if(isCourseAdded(courseCode)) {
            alert('You have already added that course!');
            return;
          }

          var courseName = $.trim( $(this).prevAll().find('.CourseTitle:last').html().split('<font')[0].replace(/&nbsp;/g, '') )
          var courseTimes = new CourseTimeStringParser(timeString)

          // Iterate through course times (a course may have different meeting times)
          for(var i in courseTimes) {
            var parsed = courseTimes[i];
            $('#cal').weekCalendar('scrollToHour', parsed.beginHour, true);

            for(var i in parsed.days) {
              var day = parsed.days[i];

              calEvent = {
                id: S4(),
                groupId: courseCode,
                start: new Date(APP_YEAR, APP_MONTH, day, parsed.beginHour, parsed.beginMin),
                end: new Date(APP_YEAR, APP_MONTH, day, parsed.endHour, parsed.endMin),
                title: courseName + '<br>(' + courseCode + ')'
              }
              $('#cal').weekCalendar("updateEvent", calEvent);
            }
          } 

          // Assign a color to the courses
          var colorPair = getRandomColorPair();
          $('.wc-cal-event').each(function(index, el) {
            var c = $(el).data().calEvent
            if( c.groupId.indexOf(courseCode) != -1 ) {
              $(this).css('background-color', colorPair.color);
              $(this).css('border', '1px solid ' + colorPair.borderColor);
              $('.wc-time', this).css('background-color', colorPair.color);
              $('.wc-time', this).css('border', '1px solid ' + colorPair.borderColor);
            }
          });

          localStorage.saved = JSON.stringify( $('#cal').weekCalendar('serializeEvents') );
        })
    });

    $('#clear-cal-btn').click(function() {
      $('#cal').weekCalendar('clear');
    });

    $('#resize-btn').toggle(function() {
      $('iframe').hide();
      $('#left').animate({width: '100%'});
      $('i', this).removeClass('icon-resize-full').addClass('icon-resize-small');
    }, function() {
      $('iframe').show()
      $('#left').animate({width: '50%'});
      $('i', this).removeClass('icon-resize-small').addClass('icon-resize-full');
    });

  });
{% endblock %}